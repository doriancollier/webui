---
title: Testing
description: Testing patterns and conventions for DorkOS
---

# Testing

DorkOS uses Vitest for all testing, with React Testing Library for component tests.

## Running Tests

<Tabs items={["All tests", "Single run", "Specific file"]}>
<Tab value="All tests">
```bash
pnpm test
```
Runs all tests in watch mode.
</Tab>
<Tab value="Single run">
```bash
pnpm test -- --run
```
Runs all tests once without watch mode. Useful for CI.
</Tab>
<Tab value="Specific file">
```bash
pnpm vitest run apps/server/src/services/__tests__/transcript-reader.test.ts
```
Runs a single test file directly.
</Tab>
</Tabs>

## Test File Structure

Tests live alongside source code in `__tests__/` directories:

<Files>
  <Folder name="apps" defaultOpen>
    <Folder name="server/src" defaultOpen>
      <Folder name="services" defaultOpen>
        <Folder name="__tests__" defaultOpen>
          <File name="transcript-reader.test.ts" />
          <File name="agent-manager.test.ts" />
          <File name="session-broadcaster.test.ts" />
        </Folder>
      </Folder>
    </Folder>
    <Folder name="client/src/layers" defaultOpen>
      <Folder name="features/chat" defaultOpen>
        <Folder name="__tests__" defaultOpen>
          <File name="ChatPanel.test.tsx" />
        </Folder>
      </Folder>
    </Folder>
  </Folder>
  <Folder name="packages" defaultOpen>
    <Folder name="test-utils" defaultOpen>
      <File name="index.ts" />
    </Folder>
  </Folder>
</Files>

## Component Tests

Component tests require the jsdom environment directive and a mock Transport.

<Steps>
<Step>
### Add the environment directive

Every component test file must start with the jsdom directive:

```typescript
/**
 * @vitest-environment jsdom
 */
```
</Step>

<Step>
### Set up the mock Transport

Use `createMockTransport()` from `@dorkos/test-utils` and wrap components in `TransportProvider`:

```typescript
import { describe, it, expect, vi } from 'vitest';
import { render, screen } from '@testing-library/react';
import '@testing-library/jest-dom';
import { TransportProvider } from '@/layers/shared/model';
import { createMockTransport } from '@dorkos/test-utils';

const mockTransport = createMockTransport();

function Wrapper({ children }: { children: React.ReactNode }) {
  return (
    <TransportProvider transport={mockTransport}>
      {children}
    </TransportProvider>
  );
}
```
</Step>

<Step>
### Write your tests

```typescript
describe('MyComponent', () => {
  it('renders expected content', () => {
    render(<MyComponent />, { wrapper: Wrapper });
    expect(screen.getByText('Expected')).toBeInTheDocument();
  });
});
```
</Step>
</Steps>

## Service Tests

Server tests mock Node.js modules like `fs/promises`:

```typescript
import { describe, it, expect, vi } from 'vitest';

vi.mock('fs/promises');

describe('TranscriptReader', () => {
  it('returns session when found', async () => {
    vi.mocked(readFile).mockResolvedValue(Buffer.from(mockJsonl));
    const result = await transcriptReader.getSession('test-id');
    expect(result).toEqual(expect.objectContaining({ id: 'test-id' }));
  });
});
```

## Hook Tests

```typescript
import { renderHook, waitFor } from '@testing-library/react';

describe('useCustomHook', () => {
  it('returns expected state', async () => {
    const { result } = renderHook(() => useCustomHook(), {
      wrapper: Wrapper,
    });

    await waitFor(() => {
      expect(result.current.data).toBeDefined();
    });
  });
});
```

## Key Conventions

<TypeTable type={{
  "@vitest-environment jsdom": { type: "directive", description: "Required at the top of every component test file" },
  "createMockTransport()": { type: "function", description: "Creates a fully mocked Transport object from @dorkos/test-utils" },
  "TransportProvider wrapper": { type: "pattern", description: "Wrap components in TransportProvider with mock Transport" },
  "@testing-library/jest-dom": { type: "import", description: "Provides DOM assertion matchers like toBeInTheDocument()" },
  "matchMedia mock": { type: "pattern", description: "Mock window.matchMedia in beforeAll for responsive components" }
}} />

## Mock Browser APIs

<Callout type="warn">
Components that use browser APIs like `matchMedia` need explicit mocks. Add these in `beforeAll` and clean up in `afterEach`.
</Callout>

```typescript
beforeAll(() => {
  Object.defineProperty(window, 'matchMedia', {
    writable: true,
    value: vi.fn().mockImplementation((query) => ({
      matches: false,
      media: query,
      onchange: null,
      addListener: vi.fn(),
      removeListener: vi.fn(),
      addEventListener: vi.fn(),
      removeEventListener: vi.fn(),
      dispatchEvent: vi.fn(),
    })),
  });
});
```

## Test Utilities

The `@dorkos/test-utils` package provides:

- `createMockTransport()` â€” Creates a fully mocked Transport object with all 9 methods
- Mock factories for sessions, messages, and other domain objects

## Anti-Patterns

<Callout type="error">
Avoid these common testing mistakes.
</Callout>

```typescript
// NEVER test implementation details
expect(component.state.isOpen).toBe(true); // Wrong - test behavior instead

// NEVER use waitFor without an assertion
await waitFor(() => {}); // Wrong - always include an expect()

// NEVER leave console mocks without cleanup
vi.spyOn(console, 'error'); // Add mockRestore in afterEach

// NEVER use arbitrary timeouts
await new Promise((r) => setTimeout(r, 1000)); // Wrong - use waitFor
```

## Next Steps

<Cards>
  <Card title="Architecture" href="/docs/contributing/architecture">
    Understand the Transport interface and how mock Transports fit in
  </Card>
  <Card title="Development Setup" href="/docs/contributing/development-setup">
    Get your local environment configured for running tests
  </Card>
  <Card title="API Reference" href="/docs/api">
    Explore the endpoints your tests may need to mock
  </Card>
</Cards>
