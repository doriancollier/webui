---
title: SSE Protocol
description: Server-Sent Events streaming protocol reference
---

# SSE Protocol

DorkOS uses Server-Sent Events (SSE) for two purposes: real-time message streaming and cross-client session synchronization.

## Message Streaming

When a client sends a message, the server responds with an SSE stream:

```
POST /api/sessions/:id/messages
Content-Type: application/json

{ "content": "Hello, Claude", "cwd": "/path/to/project" }
```

Response (`Content-Type: text/event-stream`):

```
data: {"type":"text_delta","delta":"Hello"}

data: {"type":"text_delta","delta":"! How can"}

data: {"type":"text_delta","delta":" I help?"}

data: {"type":"done"}
```

## Event Types

### Text Events

<TypeTable type={{
  "text_delta": { type: "{ delta: string }", description: "Incremental text chunk for the assistant message" },
}} />

### Tool Events

<TypeTable type={{
  "tool_call_start": { type: "{ toolCallId: string, toolName: string }", description: "Tool invocation begins" },
  "tool_call_delta": { type: "{ toolCallId: string, delta: string }", description: "Incremental tool input/output" },
  "tool_call_end": { type: "{ toolCallId: string }", description: "Tool invocation completes" },
  "tool_result": { type: "{ toolCallId: string, result: string }", description: "Tool execution result" },
}} />

### Interactive Events

<TypeTable type={{
  "approval_required": { type: "{ toolCallId: string, toolName: string, input: object }", description: "Tool needs user approval before executing" },
  "question_prompt": { type: "{ toolCallId: string, questions: object }", description: "Claude is asking the user a question with options" },
}} />

### Control Events

<TypeTable type={{
  "error": { type: "{ error: string }", description: "Error occurred during execution" },
  "done": { type: "{}", description: "Message stream complete" },
  "session_status": { type: "{ status: string }", description: "Session state changed" },
  "task_update": { type: "{ tasks: TaskItem[] }", description: "Task list updated" },
}} />

### Relay Events

When `DORKOS_RELAY_ENABLED` is true, the SSE stream includes additional event types:

<TypeTable type={{
  "relay_message": { type: "{ streamEvent: StreamEvent, messageId: string }", description: "Relay response chunk containing a nested StreamEvent from the message bus" },
  "relay_receipt": { type: "{ messageId: string, traceId: string }", description: "Delivery confirmation for a Relay-routed message" },
  "message_delivered": { type: "{ messageId: string, subject: string }", description: "Message delivery notification from the Relay transport" },
}} />

## Responding to Interactive Events

<Tabs items={["Tool Approval", "Question Response"]}>

<Tab value="Tool Approval">
When `approval_required` is received, the client must approve or deny:

```bash
# Approve
POST /api/sessions/:id/approve
Content-Type: application/json
{ "toolCallId": "tc_123" }

# Deny
POST /api/sessions/:id/deny
Content-Type: application/json
{ "toolCallId": "tc_123" }
```

<Callout type="warn">
  Failing to respond to an `approval_required` event will block the agent. The SSE stream remains open until the tool call is approved or denied.
</Callout>
</Tab>

<Tab value="Question Response">
When `question_prompt` is received, submit the user's answer:

```bash
POST /api/sessions/:id/submit-answers
Content-Type: application/json
{ "toolCallId": "tc_123", "answers": { "0": "option_a" } }
```
</Tab>

</Tabs>

## Session Sync Protocol

Clients can subscribe to real-time session changes via a persistent SSE connection:

```
GET /api/sessions/:id/stream
```

### Sync Events

<TypeTable type={{
  "sync_connected": { type: "{ sessionId: string }", description: "Sent on initial SSE connection" },
  "sync_update": { type: "{ sessionId: string, timestamp: string }", description: "New content written to session JSONL file" },
}} />

<Callout type="info">
  When a `sync_update` is received, clients should re-fetch message history. The `GET /api/sessions/:id/messages` endpoint supports ETag caching (`If-None-Match` / `304`) for efficient polling.
</Callout>

<Callout type="info">
  When Relay is enabled, the SSE stream also carries `relay_message`, `relay_receipt`, and `message_delivered` events alongside standard sync events.
</Callout>

## Session Locking

The `POST /api/sessions/:id/messages` endpoint uses session locking to prevent concurrent writes.

<TypeTable type={{
  "X-Client-Id": { type: "string", description: "Client identifier header sent with each message request" },
}} />

- If a session is locked by another client, the server returns `409` with `{ error: "Session locked", code: "SESSION_LOCKED", lockedBy, lockedAt }`
- Locks auto-expire after 5 minutes
- Locks are released when SSE connections close

## Connection Lifecycle

<Steps>

<Step>
### Open the SSE connection

Client sends `POST /api/sessions/:id/messages` with message content. The response is a `text/event-stream`.
</Step>

<Step>
### Process streamed events

Server streams events as they arrive from the Claude Agent SDK. The client processes each event and updates its UI in real time.
</Step>

<Step>
### Handle interactive events

If `approval_required` or `question_prompt` events arrive, the client must respond via the appropriate endpoint before the stream continues.
</Step>

<Step>
### Stream completes

On the `done` event, the message stream ends. The client can now send another message or close the connection.
</Step>

<Step>
### Subscribe for ongoing sync

For real-time updates (including changes from other clients or CLI), open a persistent SSE connection via `GET /api/sessions/:id/stream`.
</Step>

</Steps>

## Next Steps

<Cards>
  <Card title="Building Integrations" href="/docs/integrations/building-integrations">
    Build custom clients using the Transport interface or REST API.
  </Card>
  <Card title="Tool Approval" href="/docs/guides/tool-approval">
    Learn how the tool approval flow works and how to configure permission modes.
  </Card>
  <Card title="API Reference" href="/docs/api">
    Full interactive API documentation with request and response schemas.
  </Card>
</Cards>
